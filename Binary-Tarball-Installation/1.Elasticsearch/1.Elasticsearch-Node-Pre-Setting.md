# ğŸ› ï¸ Elasticsearch Node Pre-Requisites (Tarball Deployment)

> **Target OS:** Ubuntu 22.04 / 24.04 & RHEL 8 / 9  
> **Purpose:** Prepare OS-level requirements before deploying Elasticsearch using **binary tarball**  
> **Audience:** Ops / DevOps / SRE engineers  

---

## ğŸ“Œ Overview

This guide prepares a Linux server for a **production-grade Elasticsearch cluster** using **tarball installation**.  
All steps must be executed on **every Elasticsearch node** (`es1`, `es2`, `es3`).

---

## ğŸ–¥ï¸ 1. Hostname Configuration

```bash
hostnamectl set-hostname es1.apsis.localnet
exec bash
hostname
```

â¡ï¸ Replace hostname accordingly:
- `es2.apsis.localnet`
- `es3.apsis.localnet`

---

## ğŸŒ 2. Host Resolution (`/etc/hosts`)

```bash
cat <<EOF | tee -a /etc/hosts
192.168.20.128 es1 es1.apsis.localnet
192.168.20.129 es2 es2.apsis.localnet
192.168.20.130 es3 es3.apsis.localnet
EOF
```

Verify:
```bash
getent hosts es1 es2 es3
```

---

## ğŸ”„ 3. Disable Swap (MANDATORY)

### Runtime
```bash
swapoff -a
```

### Permanent (Ubuntu & RHEL)
```bash
sed -i.bak '/ swap / s/^/#/' /etc/fstab
```

Verify:
```bash
free -h
```

---

## ğŸ§  4. Disable Transparent Huge Pages (THP)

### Runtime
```bash
echo never | tee /sys/kernel/mm/transparent_hugepage/enabled
echo never | tee /sys/kernel/mm/transparent_hugepage/defrag
```

### Permanent
```bash
cat <<'EOF' | tee /etc/systemd/system/disable-thp.service
[Unit]
Description=Disable Transparent Huge Pages
After=sysinit.target

[Service]
Type=oneshot
ExecStart=/bin/sh -c "echo never > /sys/kernel/mm/transparent_hugepage/enabled"
ExecStart=/bin/sh -c "echo never > /sys/kernel/mm/transparent_hugepage/defrag"

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable disable-thp
```

---

## âš™ï¸ 5. Kernel Parameter (`vm.max_map_count`)

```bash
cat <<EOF | tee /etc/sysctl.d/99-elasticsearch.conf
vm.max_map_count=262144
EOF

sysctl --system
```

Verify:
```bash
sysctl vm.max_map_count
```

---

## ğŸ“‚ 6. File Descriptor & Process Limits

```bash
cat <<EOF | tee /etc/security/limits.d/elasticsearch.conf
elasticsearch soft nofile 65536
elasticsearch hard nofile 65536
elasticsearch soft memlock unlimited
elasticsearch hard memlock unlimited
elasticsearch soft nproc 4096
elasticsearch hard nproc 4096
EOF
```

---

## ğŸš« 7. Ensure `/var/tmp` is Executable (CRITICAL)

```bash
mount | grep /var/tmp
```

If `noexec` is present:
```bash
mount -o remount,exec /var/tmp
```

â¡ï¸ Remove `noexec` from `/etc/fstab` permanently.

---

## ğŸ”¥ 8. Firewall Configuration

### Required Ports
| Port | Purpose |
|----|--------|
| 22 | SSH |
| 9200 | ES HTTP |
| 9300 | ES Transport |

### Ubuntu (UFW)
```bash
ufw allow 22
ufw allow 9200
ufw allow 9300
ufw reload
```

### RHEL (firewalld)
```bash
firewall-cmd --permanent --add-port=9200/tcp
firewall-cmd --permanent --add-port=9300/tcp
firewall-cmd --reload
```

---

## â˜• 9. Java Installation

### âœ… Recommended
âœ” Use **Elasticsearch bundled JDK**  
â¡ï¸ No action required

### Optional (System Java)

**Ubuntu**
```bash
apt update && apt install -y openjdk-21-jdk
```

**RHEL**
```bash
dnf install -y java-21-openjdk
```

---

## â±ï¸ 10. Time Synchronization

```bash
timedatectl set-ntp true
timedatectl status
```

---

## âœ… Final Pre-Flight Checklist

```bash
hostname
swapoff --show
sysctl vm.max_map_count
ulimit -n
mount | grep /var/tmp
timedatectl status
```

---

ğŸ§  **Author:** DevOps / SRE SOP  
ğŸ“¦ **Version:** 1.0  
ğŸ” **Security-first | Production-ready**
