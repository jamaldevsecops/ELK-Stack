
# ğŸ§© Elasticsearch 9.2.3 Cluster Configuration (Production Grade)

This SOP covers **cluster configuration after tarball installation** for a **3â€‘node secured Elasticsearch cluster** using:
- TLS (custom CA)
- JVM tuning
- Security hardening
- Enrollment-tokenâ€“based future integrations

> âš ï¸ Scope  
> - Assumes Elasticsearch **already installed via tarball + systemd**
> - Certificates already generated (CA + node certs)
> - No Kibana / APM / Fleet config here

---

## ğŸ—ï¸ Target Topology

| Node | IP | Roles |
|----|----|------|
| es1 | 192.168.20.128 | master |
| es2 | 192.168.20.129 | master, data, ingest |
| es3 | 192.168.20.130 | master, data, ingest |

---

## ğŸ§  JVM Tuning (ALL NODES)

ğŸ“ File: `/etc/elasticsearch/jvm.options.d/heap.options`

```bash
-Xms4g
-Xmx4g
```

ğŸ” Rules:
- Heap = **50% of RAM**
- Max heap â‰¤ **31 GB**
- Xms == Xmx (always)

---

## ğŸ” Secure Keystore Setup (ALL NODES)

Store PKCS#12 passwords securely:

```bash
/usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.http.ssl.keystore.secure_password
/usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password
```

âœ… Do **not** put passwords in `elasticsearch.yml`

---

## ğŸ”’ Security & TLS (COMMON SETTINGS)

```yaml
xpack.security.enabled: true
xpack.security.enrollment.enabled: false
```

â„¹ï¸ Enrollment tokens will still work when **generated explicitly**.

---

## ğŸ§¾ Node Configurations

---

### ğŸŸ¦ es1 (Dedicated Master)

ğŸ“ `/etc/elasticsearch/elasticsearch.yml`

```yaml
cluster.name: nagad-escluster

node.name: es1
node.roles: [ "master" ]

path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch

discovery.seed_hosts: ["es1:9300", "es2:9300", "es3:9300"]
cluster.initial_master_nodes: ["es1", "es2", "es3"]

xpack.security.enabled: true
xpack.security.enrollment.enabled: false

xpack.security.http.ssl:
  enabled: true
  keystore.path: /etc/elasticsearch/certs/nodes/es1/es1.p12

xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: /etc/elasticsearch/certs/nodes/es1/es1.p12
  certificate_authorities: ["/etc/elasticsearch/certs/ca/ca.crt"]

http.host: 192.168.20.128
http.port: 9200

transport.host: 192.168.20.128
transport.port: 9300
```

---

### ğŸŸ© es2 (Master + Data + Ingest)

```yaml
cluster.name: nagad-escluster

node.name: es2
node.roles: ["master", "data", "ingest"]

path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch

discovery.seed_hosts: ["es1:9300", "es2:9300", "es3:9300"]
cluster.initial_master_nodes: ["es1", "es2", "es3"]

xpack.security.enabled: true
xpack.security.enrollment.enabled: false

xpack.security.http.ssl:
  enabled: true
  keystore.path: /etc/elasticsearch/certs/nodes/es2/es2.p12

xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: /etc/elasticsearch/certs/nodes/es2/es2.p12
  certificate_authorities: ["/etc/elasticsearch/certs/ca/ca.crt"]

http.host: 192.168.20.129
http.port: 9200

transport.host: 192.168.20.129
transport.port: 9300
```

---

### ğŸŸ© es3 (Master + Data + Ingest)

```yaml
cluster.name: nagad-escluster

node.name: es3
node.roles: ["master", "data", "ingest"]

path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch

discovery.seed_hosts: ["es1:9300", "es2:9300", "es3:9300"]
cluster.initial_master_nodes: ["es1", "es2", "es3"]

xpack.security.enabled: true
xpack.security.enrollment.enabled: false

xpack.security.http.ssl:
  enabled: true
  keystore.path: /etc/elasticsearch/certs/nodes/es3/es3.p12

xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: /etc/elasticsearch/certs/nodes/es3/es3.p12
  certificate_authorities: ["/etc/elasticsearch/certs/ca/ca.crt"]

http.host: 192.168.20.130
http.port: 9200

transport.host: 192.168.20.130
transport.port: 9300
```

---

## ğŸš¨ CRITICAL: Remove `cluster.initial_master_nodes`

ğŸ•’ **WHEN**:  
After cluster forms successfully **for the first time**.

ğŸ›‘ **WHY**:  
Leaving it causes:
- Cluster re-bootstrap risks
- Split-brain on restart

### âœ… Action (ALL NODES)

```bash
# Edit elasticsearch.yml
# REMOVE this line:
cluster.initial_master_nodes: ["es1", "es2", "es3"]
```

Then restart nodes **one by one**.

---

## â–¶ï¸ Startup Order (First Time)

1. Start **es1**
2. Start **es2**
3. Start **es3**

---

## ğŸ” Validation

```bash
curl -k -u elastic https://es1:9200/_cluster/health?pretty
```

Expected:
```json
"status": "green"
```

---

## ğŸ” Enrollment Token (Later Use)

Generate only when needed:

```bash
/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana
/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s node
```

---

## âœ… Outcome

âœ”ï¸ Secure TLS cluster  
âœ”ï¸ Production JVM tuning  
âœ”ï¸ No plaintext secrets  
âœ”ï¸ Enrollment-ready architecture  

