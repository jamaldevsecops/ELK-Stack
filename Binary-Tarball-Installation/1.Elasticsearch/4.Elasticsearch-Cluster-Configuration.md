
# ğŸ§© Elasticsearch 9.2.3 Cluster Configuration (Production Grade)

This SOP covers **cluster configuration after tarball installation** for a **3â€‘node secured Elasticsearch cluster** using:
- TLS (custom CA)
- JVM tuning
- Security hardening
- Enrollment-tokenâ€“based future integrations

> âš ï¸ Scope  
> - Assumes Elasticsearch **already installed via tarball + systemd**
> - Certificates already generated (CA + node certs)
> - No Kibana / APM / Fleet config here

---

## ğŸ—ï¸ Target Topology

| Node | IP | Roles |
|----|----|------|
| es1 | 192.168.20.128 | master |
| es2 | 192.168.20.129 | master, data, ingest |
| es3 | 192.168.20.130 | master, data, ingest |

---

## ğŸ§  JVM Tuning (ALL NODES)

ğŸ“ File: `/es/elasticsearch/config/jvm.options.d/heap.options`

```bash
-Xms4g
-Xmx4g
```

ğŸ” Rules:
- Heap = **50% of RAM**
- Max heap â‰¤ **31 GB**
- Xms == Xmx (always)

ğŸ“ File: `vi /es/elasticsearch/config/jvm.options.d/direct.options`
```bash
-XX:MaxDirectMemorySize=1g
```

---

## ğŸ” Secure Keystore Setup (ALL NODES)

Store PKCS#12 passwords securely:

```bash
/es/elasticsearch/bin/elasticsearch-keystore add xpack.security.http.ssl.keystore.secure_password
/es/elasticsearch/bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password
chmod 600 /es/elasticsearch/config/elasticsearch.keystore
```
```bash
mv ~/es/certs /es/elasticsearch/config/
chmod 700 /es/elasticsearch/config/certs
find /es/elasticsearch/config/certs -type d -exec chmod 700 {} \; 
find /es/elasticsearch/config/certs -type f -exec chmod 600 {} \; 
```

âœ… Do **not** put passwords in `elasticsearch.yml`

---

## ğŸ”’ Security & TLS (COMMON SETTINGS)

```yaml
xpack.security.enabled: true
xpack.security.enrollment.enabled: false
```

â„¹ï¸ Enrollment tokens will still work when **generated explicitly**.

---

## ğŸ§¾ Node Configurations

---

### ğŸŸ¦ es1 (Dedicated Master)

ğŸ“ `/es/elasticsearch/config/elasticsearch.yml`

```yaml
# ======================== Elasticsearch Configuration =========================
# ---------------------------------- Cluster -----------------------------------
cluster.name: es-cluster
# ------------------------------------ Node ------------------------------------
node.name: es1
node.roles: [ "master" ]
#node.attr.rack: r1
# ----------------------------------- Paths ------------------------------------
path.data: /es/elasticsearch/data
path.logs: /es/elasticsearch/logs
# ----------------------------------- Memory -----------------------------------
#bootstrap.memory_lock: true
# ---------------------------------- Network -----------------------------------
#network.host: 0.0.0.0
# --------------------------------- Discovery ----------------------------------
discovery.seed_hosts: ["es1:9300", "es2:9300", "es3:9300"]
cluster.initial_master_nodes: ["es1", "es2", "es3"]
# ---------------------------------- Various -----------------------------------
#action.destructive_requires_name: false
#----------------------- BEGIN SECURITY AUTO CONFIGURATION -----------------------
xpack.security.enabled: true
xpack.security.enrollment.enabled: false

# Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents
xpack.security.http.ssl:
  enabled: true
  keystore.path: certs/nodes/es1/es1.p12

# Enable encryption and mutual authentication between cluster nodes
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: certs/nodes/es1/es1.p12
  certificate_authorities: ["certs/ca/ca.crt"]


# Allow HTTP API connections from anywhere
# Connections are encrypted and require user authentication
http.host: 192.168.20.128
http.port: 9200

# Allow other nodes to join the cluster from anywhere
# Connections are encrypted and mutually authenticated
transport.host: 192.168.20.128
transport.port: 9300
#----------------------- END SECURITY AUTO CONFIGURATION -------------------------
```

---

### ğŸŸ© es2 (Master + Data + Ingest)

```yaml
# ======================== Elasticsearch Configuration =========================
# ---------------------------------- Cluster -----------------------------------
cluster.name: es-cluster
# ------------------------------------ Node ------------------------------------
node.name: es2
node.roles: ["master", "data", "ingest"]
#node.attr.rack: r1
# ----------------------------------- Paths ------------------------------------
path.data: /es/elasticsearch/data
path.logs: /es/elasticsearch/logs
# ----------------------------------- Memory -----------------------------------
#bootstrap.memory_lock: true
# ---------------------------------- Network -----------------------------------
#network.host: 0.0.0.0
# --------------------------------- Discovery ----------------------------------
discovery.seed_hosts: ["es1:9300", "es2:9300", "es3:9300"]
cluster.initial_master_nodes: ["es1", "es2", "es3"]
# ---------------------------------- Various -----------------------------------
#action.destructive_requires_name: false
#----------------------- BEGIN SECURITY AUTO CONFIGURATION -----------------------
xpack.security.enabled: true
xpack.security.enrollment.enabled: false

# Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents
xpack.security.http.ssl:
  enabled: true
  keystore.path: certs/nodes/es2/es2.p12

# Enable encryption and mutual authentication between cluster nodes
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: certs/nodes/es2/es2.p12
  certificate_authorities: ["certs/ca/ca.crt"]


# Allow HTTP API connections from anywhere
# Connections are encrypted and require user authentication
http.host: 192.168.20.129
http.port: 9200

# Allow other nodes to join the cluster from anywhere
# Connections are encrypted and mutually authenticated
transport.host: 192.168.20.129
transport.port: 9300
```

---

### ğŸŸ© es3 (Master + Data + Ingest)

```yaml
# ======================== Elasticsearch Configuration =========================
# ---------------------------------- Cluster -----------------------------------
cluster.name: es-cluster
# ------------------------------------ Node ------------------------------------
node.name: es3
node.roles: ["master", "data", "ingest"]
#node.attr.rack: r1
# ----------------------------------- Paths ------------------------------------
path.data: /es/elasticsearch/data
path.logs: /es/elasticsearch/logs
# ----------------------------------- Memory -----------------------------------
#bootstrap.memory_lock: true
# ---------------------------------- Network -----------------------------------
#network.host: 0.0.0.0
# --------------------------------- Discovery ----------------------------------
discovery.seed_hosts: ["es1:9300", "es2:9300", "es3:9300"]
cluster.initial_master_nodes: ["es1", "es2", "es3"]
# ---------------------------------- Various -----------------------------------
#action.destructive_requires_name: false
#----------------------- BEGIN SECURITY AUTO CONFIGURATION -----------------------
xpack.security.enabled: true
xpack.security.enrollment.enabled: false

# Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents
xpack.security.http.ssl:
  enabled: true
  keystore.path: certs/nodes/es1/es3.p12

# Enable encryption and mutual authentication between cluster nodes
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: certs/nodes/es3/es3.p12
  certificate_authorities: ["certs/ca/ca.crt"]


# Allow HTTP API connections from anywhere
# Connections are encrypted and require user authentication
http.host: 192.168.20.130
http.port: 9200

# Allow other nodes to join the cluster from anywhere
# Connections are encrypted and mutually authenticated
transport.host: 192.168.20.130
transport.port: 9300
```

---

## ğŸš¨ CRITICAL: Remove `cluster.initial_master_nodes`

ğŸ•’ **WHEN**:  
After cluster forms successfully **for the first time**.

ğŸ›‘ **WHY**:  
Leaving it causes:
- Cluster re-bootstrap risks
- Split-brain on restart

### âœ… Action (ALL NODES)

```bash
# Edit elasticsearch.yml
# REMOVE this line:
cluster.initial_master_nodes: ["es1", "es2", "es3"]
```

Then restart nodes **one by one**.

---

## ğŸš€ First Cluster Startup Order

1ï¸âƒ£ Start **es1**
```bash
systemctl start elasticsearch
```

2ï¸âƒ£ Wait for logs â†’ cluster elected

3ï¸âƒ£ Start **es2**, then **es3**

---

## âš ï¸ CRITICAL: Remove Bootstrap Setting

After cluster becomes **green**, on **ALL NODES**:

```bash
vi /es/elasticsearch/config/elasticsearch.yml
```

âŒ REMOVE:
```yaml
cluster.initial_master_nodes: ["es1", "es2", "es3"]
```

Then perform a **rolling restart**.

> âœ… This prevents accidental re-bootstrap & split-brain

---
## ğŸ” OS-Level Trust of Elasticsearch CA (IMPORTANT)

This step allows you to run:
```bash
curl -u elastic https://es1:9200/_cluster/health?pretty
```
**without `-k`.**

---

### ğŸŸ¦ Ubuntu / Debian

```bash
sudo cp /es/elasticsearch/config/certs/ca/ca.crt /usr/local/share/ca-certificates/nagad-es-ca.crt

sudo update-ca-certificates
```

---

### ğŸŸ¥ RHEL / Rocky / Alma

```bash
sudo cp /es/elasticsearch/config/certs/ca/ca.crt /etc/pki/ca-trust/source/anchors/nagad-es-ca.crt

sudo update-ca-trust extract
```

---



## ğŸ” Validation

```bash
curl -u elastic https://es1:9200/_cluster/health?pretty
curl -u elastic https://es1:9200/_cat/nodes?v
```

Expected:
- status: `green`
- 3 nodes present

---

## ğŸ” Enrollment Token (Later Use)

Generate only when needed:

```bash
/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana
/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s node
```

---

## âœ… Outcome

âœ”ï¸ Secure TLS cluster  
âœ”ï¸ Production JVM tuning  
âœ”ï¸ No plaintext secrets  
âœ”ï¸ Enrollment-ready architecture  
