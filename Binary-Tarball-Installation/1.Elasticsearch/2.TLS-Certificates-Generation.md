# ğŸ” Elastic Stack TLS Certificate Guide (Complete)

This document **merges and consolidates** all TLS-related SOPs for a **production-grade Elastic Stack** deployed via **binary tarballs**.

It is **certificate-only** by design â€” no users, no services, no systemd, no configs beyond TLS.

---

## ğŸ“¦ Covered Components

- ğŸ›ï¸ Root Certificate Authority (CA)
- ğŸŸ¢ Elasticsearch nodes (es1, es2, es3)
- ğŸ“Š Kibana
- ğŸ“¡ APM Server
- ğŸš¦ Fleet Server
- ğŸ¤– Elastic Agent trust model

---

## ğŸ§  Design Principles

- One **offline Root CA**
- **Unique certificate per component**
- **PKCS#12 only where required**
- Explicit trust for agents
- CA private key removed after signing

---

## ğŸ“ Recommended Directory Layout

```bash
~/es/certs
â”œâ”€â”€ ca/
â”‚   â”œâ”€â”€ ca.crt
â”‚   â””â”€â”€ ca.key   # TEMPORARY (REMOVE)
â”œâ”€â”€ nodes/
â”‚   â”œâ”€â”€ es1/
â”‚   â”œâ”€â”€ es2/
â”‚   â””â”€â”€ es3/
â”œâ”€â”€ kibana/
â”œâ”€â”€ apm-server/
â””â”€â”€ fleet-server/
```

---

## ğŸ›ï¸ 1. Root CA Generation

```bash
mkdir -p ~/es/certs/ca && cd ~/es/certs/ca

openssl genrsa -out ca.key 4096
chmod 600 ca.key

openssl req -x509 -new -sha512 -days 3650 \
  -key ca.key \
  -out ca.crt \
  -subj "/C=BD/ST=Dhaka/L=Dhaka/O=Elastic/OU=Security/CN=elastic-root-ca"
```

---

## ğŸŸ¢ 2. Elasticsearch Node Certificates (Example: es1)

```bash
mkdir -p ~/es/certs/nodes/es1 && cd ~/es/certs/nodes/es1
```

```bash
cat > es1.cnf << 'EOF'
[ req ]
distinguished_name = dn
req_extensions = v3_req
prompt = no

[ dn ]
CN = es1

[ v3_req ]
keyUsage = digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = es1
DNS.2 = es1.apsis.localnet
IP.1  = 192.168.20.128
EOF
```

```bash
openssl genrsa -out es1.key 4096
openssl req -new -key es1.key -out es1.csr -config es1.cnf

openssl x509 -req \
  -in es1.csr \
  -CA ../../ca/ca.crt \
  -CAkey ../../ca/ca.key \
  -CAcreateserial \
  -out es1.crt \
  -days 825 -sha512 \
  -extensions v3_req \
  -extfile es1.cnf
```

â¡ï¸ Repeat for **es2 (192.168.20.129)** and **es3 (192.168.20.130)**.

---

## ğŸ” 3. PKCS#12 Conversion (Elasticsearch Only)

Elasticsearch **requires PKCS#12**.

```bash
openssl pkcs12 -export \
  -in es1.crt \
  -inkey es1.key \
  -certfile ../../ca/ca.crt \
  -out es1.p12
```

Repeat for es2 / es3.

---

## ğŸ“Š 4. Kibana Certificate (PEM)

```bash
mkdir -p ~/es/certs/nodes/kibana && cd ~/es/certs/nodes/kibana
```
```bash
cat > kibana.cnf << 'EOF'
[ req ]
distinguished_name = dn
req_extensions = v3_req
prompt = no


[ dn ]
CN = kibana


[ v3_req ]
keyUsage = digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names


[ alt_names ]
DNS.1 = kibana
DNS.2 = kibana.apsis.localnet
IP.1 = 192.168.20.131
EOF
```
```bash
openssl genrsa -out kibana.key 4096
openssl req -new -key kibana.key -out kibana.csr -config kibana.cnf
```
```bash
openssl x509 -req \
  -in kibana.csr \
  -CA ../../ca/ca.crt \
  -CAkey ../../ca/ca.key \
  -CAcreateserial \
  -out kibana.crt \
  -days 825 -sha512 \
  -extensions v3_req \
  -extfile kibana.cnf
```

- Uses `.crt + .key`
- Trusts CA only
- PKCS#12 **not required**

---

## ğŸ“¡ 5. APM Server Certificate (PEM)

- Uses `.crt + .key`
- PKCS#12 **not supported**

---

## ğŸš¦ 6. Fleet Server Certificate (PEM)

```bash
mkdir -p /etc/elastic-certs/fleet-server
```

- Uses `.crt + .key`
- SAN **must match URL**
- Never holds CA key

---

## ğŸ§¹ 7. REMOVE CA PRIVATE KEY (CRITICAL)

```bash
rm -f /etc/elastic-certs/ca/ca.key
```

âœ… CA becomes offline-only  
âœ… No service can issue certificates

---

## ğŸ¤– 8. Elastic Agent Trust Models

### ğŸ…°ï¸ Model A â€” CA Push (Recommended)

```bash
elastic-agent enroll \
  --url=https://fleet-server:8220 \
  --certificate-authorities=/etc/elastic-agent/certs/ca.crt
```

**Pros**
- Explicit trust
- Easy rotation

---

### ğŸ…±ï¸ Model B â€” OS Trust Store

#### Ubuntu
```bash
cp ~/es/certs/ca/ca.crt /usr/local/share/ca-certificates/elastic-ca.crt
update-ca-certificates
```

#### RHEL
```bash
cp ~/es/certs/ca/ca.crt /etc/pki/ca-trust/source/anchors/elastic-ca.crt
update-ca-trust extract
```

---

## Transfer the Certificates
```bash
# Transfer CA Cert
scp ~/es/certs/ca/ca.crt ops@192.168.20.129:/home/ops/
scp ~/es/certs/ca/ca.crt ops@192.168.20.130:/home/ops/

# Transfer Node's Certs
scp -rp ~/es/certs/nodes/es2/es2.p12 ops@192.168.20.129:/home/ops/
scp -rp ~/es/certs/nodes/es3/es3.p12 ops@192.168.20.129:/home/ops/
```

---

## âŒ 10. Common Certificate Mistakes

| Mistake | Result |
|------|------|
CA key left online | âŒ Critical risk |
Same cert reused | âŒ TLS failure |
Missing SAN | âŒ Handshake fail |
Plaintext passwords | âŒ Audit fail |

---

## âœ… 11. Final Certificate Checklist

- [ ] Offline CA
- [ ] Unique certs
- [ ] PKCS#12 only for ES
- [ ] CA key removed
- [ ] Agent trust model chosen
- [ ] Passwords in keystore

---

## ğŸ§­ End of TLS Scope

This document intentionally stops here.
