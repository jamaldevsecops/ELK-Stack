# ğŸ§© Elasticsearch Cluster Configuration Guide  
Based on Your Architecture & Production Decisions

This document provides **cluster-level configuration instructions** for your setup, focusing on **node roles, discovery, security, and stability**, assuming **TLS certificates are already in place**.

---

## ğŸ—ï¸ Target Architecture

| Server | Services | Elasticsearch Roles |
|------|--------|---------------------|
| Server 1 | Elasticsearch + Kibana | master (dedicated) |
| Server 2 | Elasticsearch + Logstash | master, data, ingest |
| Server 3 | Elasticsearch + Logstash | master, data, ingest |

---

## ğŸ§  Core Cluster Rules

- Use an **odd number of master-eligible nodes**
- Dedicated master nodes should **not run data or ingest**
- Data nodes may also be master-eligible in small clusters
- TLS must be enabled **before first cluster start**

---

## ğŸ”‘ Common Cluster Settings (ALL Nodes)

```yaml
cluster.name: nagad-escluster
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
```

---

## ğŸ§­ Node Role Configuration

### es1 (Dedicated Master)
```yaml
node.name: es1
node.roles: ["master"]
```

### es2 (Data + Master + Ingest)
```yaml
node.name: es2
node.roles: ["master", "data", "ingest"]
```

### es3 (Data + Master + Ingest)
```yaml
node.name: es3
node.roles: ["master", "data", "ingest"]
```

---

## ğŸŒ Network Binding (Example es1)

```yaml
http.host: 192.168.20.126
http.port: 9200

transport.host: 192.168.20.126
transport.port: 9300
```

(Change IP per node)

---

## ğŸ” Discovery Configuration (ALL Nodes)

```yaml
discovery.seed_hosts:
  - es1:9300
  - es2:9300
  - es3:9300
```

---

## ğŸš€ Initial Cluster Bootstrap (FIRST START ONLY)

```yaml
cluster.initial_master_nodes:
  - es1
  - es2
  - es3
```

---

## ğŸ” Security (ALL Nodes)

```yaml
xpack.security.enabled: true
xpack.security.enrollment.enabled: false
```

---

## ğŸ” HTTP TLS (Per Node Example)

```yaml
# Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents
xpack.security.http.ssl:
  enabled: true
  keystore.path: /etc/elasticsearch/certs/nodes/es1/es1.p12
```

---

## ğŸ” Transport TLS (ALL Nodes)

```yaml
# Enable encryption and mutual authentication between cluster nodes
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: /etc/elasticsearch/certs/nodes/es1/es1.p12
  certificate_authorities: ["/etc/elasticsearch/certs/ca/ca.crt"]
```

---

## ğŸ”‘ Configuration (On es1)

```yaml
# ======================== Elasticsearch Configuration =========================
# ---------------------------------- Cluster -----------------------------------
cluster.name: nagad-escluster
# ------------------------------------ Node ------------------------------------
node.name: es1
node.roles: [ "master" ]
#node.attr.rack: r1
# ----------------------------------- Paths ------------------------------------
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
# ----------------------------------- Memory -----------------------------------
#bootstrap.memory_lock: true
# ---------------------------------- Network -----------------------------------
#network.host: 0.0.0.0
# --------------------------------- Discovery ----------------------------------
discovery.seed_hosts: ["es1:9300", "es2:9300", "es3:9300"]
cluster.initial_master_nodes: ["es1", "es2", "es3"]
# ---------------------------------- Various -----------------------------------
#action.destructive_requires_name: false
#----------------------- BEGIN SECURITY AUTO CONFIGURATION -----------------------
xpack.security.enabled: true
xpack.security.enrollment.enabled: false

# Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents
xpack.security.http.ssl:
  enabled: true
  keystore.path: /etc/elasticsearch/certs/nodes/es1/es1.p12

# Enable encryption and mutual authentication between cluster nodes
#xpack.security.transport.ssl:
  #enabled: true
  #verification_mode: certificate
  #keystore.path: /etc/elasticsearch/certs/nodes/es1/es1.p12
  #truststore.path: /etc/elasticsearch/certs/ca/ca.crt

xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: /etc/elasticsearch/certs/nodes/es1/es1.p12
  certificate_authorities: ["/etc/elasticsearch/certs/ca/ca.crt"]


# Allow HTTP API connections from anywhere
# Connections are encrypted and require user authentication
http.host: 192.168.20.128
http.port: 9200

# Allow other nodes to join the cluster from anywhere
# Connections are encrypted and mutually authenticated
transport.host: 192.168.20.128
transport.port: 9300

#----------------------- END SECURITY AUTO CONFIGURATION -------------------------
```

---

## â–¶ï¸ Startup Order

1. Start es1
2. Start es2
3. Start es3

```bash
systemctl start elasticsearch
```

---

## ğŸ§ª Validation

```bash
curl -k -u elastic https://es1:9200/_cluster/health?pretty
```

Expected:
- number_of_nodes: 3
- status: green

---

ğŸ” How to reset the elastic password (safe method)

Run this on any one node (once cluster is up):  
```bash
/usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
```
Youâ€™ll be prompted:
Generate automatically? â†’ Y (recommended), or
Enter your own strong password
ğŸ“Œ This updates the password cluster-wide.

---

ğŸ§ª Verify after reset
```bash
curl -k -u elastic https://es1:9200/_cluster/health?pretty
```
---

## ğŸ“¦ Shard Strategy

- Data nodes: 2
- Recommended replicas: **1**
- Do not use replicas = 2

---

## âœ… Outcome

- Stable master election
- Secure transport & HTTP
- Production-ready cluster behavior
---
Nex: [Sanity Check](https://github.com/jamaldevsecops/ELK-Stack/blob/master/Package-Based-Installation/Sanity-Check.md)
Prev: [Gnerate TLS Certificates](https://github.com/jamaldevsecops/ELK-Stack/blob/master/Package-Based-Installation/Generate-TLS-Certificates.md)
