# üß© Elasticsearch Cluster Configuration Guide  
Based on Your Architecture & Production Decisions

This document provides **cluster-level configuration instructions** for your setup, focusing on **node roles, discovery, security, and stability**, assuming **TLS certificates are already in place**.

---

## üèóÔ∏è Target Architecture

| Server | Services | Elasticsearch Roles |
|------|--------|---------------------|
| Server 1 | Elasticsearch + Kibana | master (dedicated) |
| Server 2 | Elasticsearch + Logstash | master, data, ingest |
| Server 3 | Elasticsearch + Logstash | master, data, ingest |

---

## üß† Core Cluster Rules

- Use an **odd number of master-eligible nodes**
- Dedicated master nodes should **not run data or ingest**
- Data nodes may also be master-eligible in small clusters
- TLS must be enabled **before first cluster start**

---

## üîë Common Cluster Settings (ALL Nodes)

```yaml
cluster.name: nagad-escluster
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
```

---

## üß≠ Node Role Configuration

### es1 (Dedicated Master)
```yaml
node.name: es1
node.roles: ["master"]
```

### es2 (Data + Master + Ingest)
```yaml
node.name: es2
node.roles: ["master", "data", "ingest"]
```

### es3 (Data + Master + Ingest)
```yaml
node.name: es3
node.roles: ["master", "data", "ingest"]
```

---

## üåê Network Binding (Example es1)

```yaml
http.host: 192.168.20.126
http.port: 9200

transport.host: 192.168.20.126
transport.port: 9300
```

(Change IP per node)

---

## üîé Discovery Configuration (ALL Nodes)

```yaml
discovery.seed_hosts:
  - es1:9300
  - es2:9300
  - es3:9300
```

---

## üöÄ Initial Cluster Bootstrap (FIRST START ONLY)

```yaml
cluster.initial_master_nodes:
  - es1
  - es2
  - es3
```

---

## üîê Security (ALL Nodes)

```yaml
xpack.security.enabled: true
xpack.security.enrollment.enabled: false
```

---

## üîê HTTP TLS (Per Node Example)

```yaml
# Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents
xpack.security.http.ssl:
  enabled: true
  keystore.path: /etc/elasticsearch/certs/nodes/es1/es1.p12
```

---

## üîê Transport TLS (ALL Nodes)

```yaml
# Enable encryption and mutual authentication between cluster nodes
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: /etc/elasticsearch/certs/nodes/es1/es1.p12
  certificate_authorities: ["/etc/elasticsearch/certs/ca/ca.crt"]
```
üìå Use `certificate_authorities` for `.crt` (PEM)  
üìå Use `truststore.path` only for `.p12` / `.jks`

---

## ‚öôÔ∏è Configuration (On es1)

```yaml
# ======================== Elasticsearch Configuration =========================
# ---------------------------------- Cluster -----------------------------------
cluster.name: nagad-escluster
# ------------------------------------ Node ------------------------------------
node.name: es1
node.roles: [ "master" ]
#node.attr.rack: r1
# ----------------------------------- Paths ------------------------------------
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
# ----------------------------------- Memory -----------------------------------
#bootstrap.memory_lock: true
# ---------------------------------- Network -----------------------------------
#network.host: 0.0.0.0
# --------------------------------- Discovery ----------------------------------
discovery.seed_hosts: ["es1:9300", "es2:9300", "es3:9300"]
cluster.initial_master_nodes: ["es1", "es2", "es3"]
# ---------------------------------- Various -----------------------------------
#action.destructive_requires_name: false
#----------------------- BEGIN SECURITY AUTO CONFIGURATION -----------------------
xpack.security.enabled: true
xpack.security.enrollment.enabled: false

# Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents
xpack.security.http.ssl:
  enabled: true
  keystore.path: /etc/elasticsearch/certs/nodes/es1/es1.p12

# Enable encryption and mutual authentication between cluster nodes
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: /etc/elasticsearch/certs/nodes/es1/es1.p12
  certificate_authorities: ["/etc/elasticsearch/certs/ca/ca.crt"]


# Allow HTTP API connections from anywhere
# Connections are encrypted and require user authentication
http.host: 192.168.20.128
http.port: 9200

# Allow other nodes to join the cluster from anywhere
# Connections are encrypted and mutually authenticated
transport.host: 192.168.20.128
transport.port: 9300

#----------------------- END SECURITY AUTO CONFIGURATION -------------------------
```
---
## ‚öôÔ∏è Configuration (On es2)
```yaml
# ======================== Elasticsearch Configuration =========================
# ---------------------------------- Cluster -----------------------------------
cluster.name: nagad-escluster
# ------------------------------------ Node ------------------------------------
node.name: es2
node.roles: ["master", "data", "ingest"]
#node.attr.rack: r1
# ----------------------------------- Paths ------------------------------------
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
# ----------------------------------- Memory -----------------------------------
#bootstrap.memory_lock: true
# ---------------------------------- Network -----------------------------------
#network.host: 0.0.0.0
# --------------------------------- Discovery ----------------------------------
discovery.seed_hosts: ["es1:9300", "es2:9300", "es3:9300"]
cluster.initial_master_nodes: ["es1", "es2", "es3"]
# ---------------------------------- Various -----------------------------------
#action.destructive_requires_name: false
#----------------------- BEGIN SECURITY AUTO CONFIGURATION -----------------------
xpack.security.enabled: true
xpack.security.enrollment.enabled: false

# Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents
xpack.security.http.ssl:
  enabled: true
  keystore.path: /etc/elasticsearch/certs/nodes/es2/es2.p12

# Enable encryption and mutual authentication between cluster nodes
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: /etc/elasticsearch/certs/nodes/es2/es2.p12
  certificate_authorities: ["/etc/elasticsearch/certs/ca/ca.crt"]


# Allow HTTP API connections from anywhere
# Connections are encrypted and require user authentication
http.host: 192.168.20.129
http.port: 9200

# Allow other nodes to join the cluster from anywhere
# Connections are encrypted and mutually authenticated
transport.host: 192.168.20.129
transport.port: 9300
```
---
## ‚öôÔ∏è Configuration (On es3)
```yaml
# ======================== Elasticsearch Configuration =========================
# ---------------------------------- Cluster -----------------------------------
cluster.name: nagad-escluster
# ------------------------------------ Node ------------------------------------
node.name: es3
node.roles: ["master", "data", "ingest"]
#node.attr.rack: r1
# ----------------------------------- Paths ------------------------------------
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
# ----------------------------------- Memory -----------------------------------
#bootstrap.memory_lock: true
# ---------------------------------- Network -----------------------------------
#network.host: 0.0.0.0
# --------------------------------- Discovery ----------------------------------
discovery.seed_hosts: ["es1:9300", "es2:9300", "es3:9300"]
cluster.initial_master_nodes: ["es1", "es2", "es3"]
# ---------------------------------- Various -----------------------------------
#action.destructive_requires_name: false
#----------------------- BEGIN SECURITY AUTO CONFIGURATION -----------------------
xpack.security.enabled: true
xpack.security.enrollment.enabled: false

# Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents
xpack.security.http.ssl:
  enabled: true
  keystore.path: /etc/elasticsearch/certs/nodes/es3/es3.p12

# Enable encryption and mutual authentication between cluster nodes
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: /etc/elasticsearch/certs/nodes/es3/es3.p12
  certificate_authorities: ["/etc/elasticsearch/certs/ca/ca.crt"]


# Allow HTTP API connections from anywhere
# Connections are encrypted and require user authentication
http.host: 192.168.20.130
http.port: 9200

# Allow other nodes to join the cluster from anywhere
# Connections are encrypted and mutually authenticated
transport.host: 192.168.20.130
transport.port: 9300

#----------------------- END SECURITY AUTO CONFIGURATION -------------------------
```
---

## ‚ñ∂Ô∏è Startup Order

1. Start es1
2. Start es2
3. Start es3

```bash
systemctl start elasticsearch
```

---

## üß™ Validation

```bash
curl -k -u elastic https://es1:9200/_cluster/health?pretty
```

Expected:
- number_of_nodes: 3
- status: green

---

üîÅ How to reset the elastic password (safe method)

Run this on any one node (once cluster is up):  
```bash
/usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
```
You‚Äôll be prompted:  
Generate automatically? ‚Üí Y (recommended), or  
Enter your own strong password  
üìå This updates the password cluster-wide.  

```
This tool will reset the password of the [elastic] user to an autogenerated value.
The password will be printed in the console.
Please confirm that you would like to continue [y/N]y


Password for the [elastic] user successfully reset.
New value: 7jul1lKyCwPrxkwO-RLu

```
---

## ‚úÖ Outcome

- Stable master election
- Secure transport & HTTP
- Production-ready cluster behavior
---
Nex: [Sanity Check](https://github.com/jamaldevsecops/ELK-Stack/blob/master/Package-Based-Installation/4.Sanity-Check.md)  
Prev: [Gnerate TLS Certificates](https://github.com/jamaldevsecops/ELK-Stack/blob/master/Package-Based-Installation/2.Generate-TLS-Certificates.md)
