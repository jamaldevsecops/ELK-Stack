# ğŸš€ Fleet Server Deployment Guide (with Certificate Generation)
(Selfâ€‘Managed Elastic Stack)

This guide provides **stepâ€‘byâ€‘step instructions** to deploy **Fleet Server** in a **selfâ€‘managed Elasticsearch + Kibana environment** with **TLS enabled**, including **Fleet Server certificate generation using your existing Elasticsearch CA**.

---

## ğŸ§­ Architecture Overview

Elastic Agents â†’ Fleet Server (Elastic Agent) â†’ Elasticsearch Cluster  
                                     â†˜ Kibana (Fleet UI)

Fleet Server acts as the **control plane** for Elastic Agents.

---

## âœ… Prerequisites

### Infrastructure
- Elasticsearch cluster (healthy)
- Kibana with Fleet enabled
- Linux host for Fleet Server
- Static IP / DNS for Fleet Server

### Network
| Service | Port |
|------|------|
| Fleet Server | 8220 |
| Elasticsearch | 9200 |
| Kibana | 5601 |

---

## ğŸ” Certificate Strategy (Recommended)

Use **one internal CA** (your Elasticsearch CA) for:
- Elasticsearch HTTP
- Fleet Server HTTPS

You will need:
- `ca.crt`
- `ca.key` (temporary, only for signing)
- `fleet-server.crt`
- `fleet-server.key`

> â— The CA **private key must be removed after signing**.

---

## ğŸ§© Step 1: Prepare Certificate Directory

On Fleet Server host:

```bash
mkdir -p /etc/elastic-agent/certs
cd /etc/elastic-agent/certs
```

Copy CA certificate **and key** from any Elasticsearch node:

```bash
scp -rp root@es1:/etc/elasticsearch/certs/ca .
```

---

## ğŸ§© Step 2: Create OpenSSL Config for Fleet Server

```bash
cat > fleet-openssl.cnf << 'EOF'
[ req ]
distinguished_name = req_distinguished_name
req_extensions = v3_req
prompt = no

[ req_distinguished_name ]
CN = fleet-server

[ v3_req ]
keyUsage = digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = fleet-server
DNS.2 = es1.apsis.localnet
IP.1  = 192.168.20.128
EOF
```

> âœ” Always include **DNS and IP SANs** that agents will use.

---

## ğŸ§© Step 3: Generate Fleet Server Key & CSR

```bash
openssl genrsa -out fleet-server.key 4096

openssl req -new   -key fleet-server.key   -out fleet-server.csr   -config fleet-openssl.cnf
```

---

## ğŸ§© Step 4: Sign Fleet Server Certificate with ES CA

```bash
openssl x509 -req   -in fleet-server.csr   -CA /etc/elastic-agent/certs/ca/ca.crt   -CAkey /etc/elastic-agent/certs/ca/ca.key   -CAcreateserial   -out fleet-server.crt   -days 825   -sha512   -extensions v3_req   -extfile fleet-openssl.cnf
```

---

## ğŸ§© Step 5: Secure Permissions & Remove CA Key

```bash
chmod 600 /etc/elastic-agent/certs/fleet-server.key
chmod 644 /etc/elastic-agent/certs/*.crt

# REMOVE CA PRIVATE KEY (IMPORTANT)
rm -f /etc/elastic-agent/certs/ca/ca.key
```

âœ… Fleet Server no longer holds CA signing authority.

---

## ğŸ§© Step 6: Configure Fleet in Kibana

Navigate to:
**Kibana â†’ Management â†’ Fleet â†’ Settings**

### Fleet Server Hosts
```
https://192.168.20.128:8220
```

### Elasticsearch Output
```
https://es1:9200
https://es2:9200
https://es3:9200
```

Save settings.

---

## ğŸ§© Step 7: Create Fleet Server Policy

Fleet â†’ Agent Policies â†’ Create policy  
Name: `fleet-server-policy`  
Enable **Fleet Server integration**.

---

## ğŸ§© Step 8: Generate Fleet Server Service Token

On any Elasticsearch node:

```bash
/usr/share/elasticsearch/bin/elasticsearch-service-tokens create   elastic/fleet-server fleet-server-token
```

Save the token securely.

---

## ğŸ§© Step 9: Install Fleet Server (Elastic Agent)

```bash
sudo ./elastic-agent install   --url=https://192.168.20.128:8220   --fleet-server-es=https://es1:9200   --fleet-server-service-token=<TOKEN>   --fleet-server-policy=fleet-server-policy   --certificate-authorities=/etc/elasticsearch/certs/ca/ca.crt   --fleet-server-es-ca=/etc/elasticsearch/certs/ca/ca.crt   --fleet-server-cert=/etc/elastic-agent/certs/fleet-server.crt   --fleet-server-cert-key=/etc/elastic-agent/certs/fleet-server.key   --fleet-server-port=8220   --install-servers
```

---

## ğŸ§ª Verification

```bash
systemctl status elastic-agent
ss -lntp | grep 8220
```

Kibana â†’ Fleet â†’ Agents â†’ **Healthy**

---

## ğŸ”’ Client Authentication (mTLS)

| Mode | Recommendation |
|---|---|
| None | âœ… Default |
| Required | âŒ Advanced (agent certs required) |

---

## ğŸ“Œ Summary

Fleet Server:
- Is a **control plane**
- Uses TLS + service tokens
- Requires CA trust at first enrollment
- Scales independently from Elasticsearch

---

Happy Observability ğŸš€
